<script>
  const banButton = document.getElementById('ban-btn'),
        muteButton = document.getElementById('mute-btn'),
        changeUsernameButton = document.getElementById('name-change-btn');

  const banModal = document.getElementById('modal-ban-player');

  const banModalUsername = document.querySelector('#modal-ban-player-username > span'),
        banModalTimePeriodSelect = document.getElementById('modal-ban-player-time-select'),
        banModalCustomTimePeriod = document.getElementById('modal-ban-player-time-custom');
  const banModalBanButton = document.getElementById('modal-ban-player-btn'),
        banModalMercyButton = document.getElementById('modal-cancel-ban-btn');

  function addDaysToCurrentDate(days) {
    const currentDate = new Date();
    
    // Get the current timestamp, and add days converted to milliseconds because .setDate()/.getDate()
    // give wildly inaccurate results for some reason
    const futureTime = currentDate.getTime() + (days * 24 * 60 * 60 * 1000);
    return new Date(futureTime);
  }

  function resetBanModalInputs() {
    banModalTimePeriodSelect.value = 1;
    banModalCustomTimePeriod.value = "";
  }

  async function banUser() {
    if (banModalTimePeriodSelect.value === -1) {
      if (banModalCustomTimePeriod.value == "" || banModalCustomTimePeriod.value == null) {
        alert('Please enter amount of days for custom ban time length');
        return;
      }
    }

    let numberOfDays = banModalTimePeriodSelect.value == -1 ? banModalCustomTimePeriod.value : banModalTimePeriodSelect.value;
    let banDate = addDaysToCurrentDate(numberOfDays);

    if (confirm(`Are you sure you want to ban ${account.username} for ${numberOfDays} day(s)?`)) {
      fetch(`/mod/ban/${account.id}`, {
        method: 'POST',
        body: JSON.stringify({
          banned_until: banDate.toISOString()
        }),
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(res => {
        if (res.status == 200) {
          banModal.close();
          alert(`Successfully banned ${account.username} for ${numberOfDays} day(s).`);
          window.location.reload();
        } else {
          alert('Something went wrong. Please signout and back in, then try again.');
        }
      });
    }
  }

  async function muteUser() {
    alert('Not yet implemented! Please try again on another date.');
  }

  async function changeUsername() {

  }

  muteButton.addEventListener('click', muteUser);
  changeUsernameButton.addEventListener('click', changeUsername);

  banButton.addEventListener('click', (event) => {
    if (account.banned_until) {
      alert(`${account.username} is already banned!`);
      return;
    }
    
    banModalTimePeriodSelect.value = 1;
    banModal.showModal();
  });
  banModalMercyButton.addEventListener('click', (event) => {
    banModal.close();
  });
  banModalBanButton.addEventListener('click', banUser);

  banModalTimePeriodSelect.addEventListener('change', (event) => {
    const newValue = event.target.value;
    if (newValue == -1) {
      banModalCustomTimePeriod.classList.remove('hidden');
    } else {
      banModalCustomTimePeriod.classList.add('hidden');
    }
  });

  banModalUsername.textContent = account.username;
  resetBanModalInputs();
</script>